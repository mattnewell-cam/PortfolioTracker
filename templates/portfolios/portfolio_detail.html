{% extends "portfolios/base.html" %}

{% block title %}{{ portfolio.name }}{% endblock %}

{% block content %}
  <h1 class="mb-1">{{ portfolio.name }}</h1>
  {% if portfolio.short_description %}
    <p class="text-muted mb-4">{{ portfolio.short_description }}</p>
  {% else %}
    <div class="mb-4"></div>
  {% endif %}

  {% if is_owner %}
    <form method="post" action="{% url 'portfolios:portfolio-toggle-privacy' %}" class="mb-3">
      {% csrf_token %}
      <button type="submit" class="btn btn-secondary">
        {% if portfolio.is_private %}
          Make Portfolio Public
        {% else %}
          Make Portfolio Private
        {% endif %}
      </button>
    </form>
  {% endif %}

  {% if private_view %}
    <p class="text-muted"><em>This portfolio is private. Only the value chart is visible.</em></p>
  {% endif %}

  {% if not private_view %}
  <div class="card mb-4">
    <div class="card-body">
      <p>
        <strong>Cash Balance (USD):</strong>
        ${{ portfolio.cash_balance|floatformat:2 }}
      </p>
      {% if is_owner %}
      <p class="mt-3">
        <a class="btn btn-primary" href="{% url 'portfolios:order-create' %}">
          Place Buy/Sell Order
        </a>
      </p>
      {% endif %}
    </div>
  </div>

  <!-- Current Holdings -->
  <h2 class="h5 mb-3">Current Holdings</h2>
  {% if positions %}
    <div class="table-responsive mb-4">
      <table class="table table-striped w-100">
        <thead class="table-light">
          <tr>
            <th scope="col">Symbol</th>
            <th scope="col">Quantity</th>
            <th scope="col">Price (local)</th>
            <th scope="col">FX Rate (â†’USD)</th>
            <th scope="col">Value (USD)</th>
          </tr>
        </thead>
        <tbody>
          {% for pos in positions %}
            <tr>
              <td>{{ pos.symbol }}</td>
              <td>{{ pos.quantity }}</td>
              <td>
                {% if pos.mid_local is not None %}
                  {{ pos.mid_local|floatformat:2 }} {{ pos.currency }}
                {% else %}
                  N/A
                {% endif %}
              </td>
              <td>
                {% if pos.fx_rate is not None %}
                  1 {{ pos.currency }} = ${{ pos.fx_rate|floatformat:4 }}
                {% else %}
                  N/A
                {% endif %}
              </td>
              <td>
                {% if pos.value_usd is not None %}
                  ${{ pos.value_usd|floatformat:2 }}
                {% else %}
                  N/A
                {% endif %}
              </td>
            </tr>
          {% endfor %}
          <tr>
            <td>Cash</td>
            <td></td>
            <td></td>
            <td></td>
            <td>${{ portfolio.cash_balance|floatformat:2 }}</td>
          </tr>
          <tr class="table-light">
            <td colspan="4"><strong>Total Value</strong></td>
            <td><strong>${{ total_value|floatformat:2 }}</strong></td>
          </tr>
        </tbody>
      </table>
    </div>
  {% else %}
    <p class="text-muted"><em>No holdings in this portfolio yet.</em></p>
  {% endif %}
  {% endif %}

  <!-- Value Over Time -->
  <h2 class="h5 mb-3">Value Over Time</h2>
  <div class="mb-2">
    <div class="btn-group btn-group-sm" role="group" id="rangeButtons">
      <button type="button" class="btn btn-outline-primary active" data-range="max">Max</button>
      <button type="button" class="btn btn-outline-primary" data-range="5y">5Y</button>
      <button type="button" class="btn btn-outline-primary" data-range="1y">1Y</button>
      <button type="button" class="btn btn-outline-primary" data-range="ytd">YTD</button>
      <button type="button" class="btn btn-outline-primary" data-range="6m">6M</button>
      <button type="button" class="btn btn-outline-primary" data-range="1m">1M</button>
    </div>
  </div>
  <p id="returnSummary" class="mb-2 small"></p>
  <div class="mb-4">
    <canvas id="historyChart" style="max-width:100%; height:auto;"></canvas>
  </div>

  <div class="mb-4">
    <div class="dropdown">
      <button class="btn btn-secondary dropdown-toggle" type="button" id="benchmarkDropdown" data-bs-toggle="dropdown" aria-expanded="false">
        Select Benchmarks
      </button>
      <div class="dropdown-menu p-2" aria-labelledby="benchmarkDropdown">
        {% for bm in benchmark_data %}
          <div class="form-check">
            <input
              class="form-check-input benchmark-option"
              type="checkbox"
              id="bmOption{{ forloop.counter0 }}"
              data-index="{{ forloop.counter0 }}"
              {% if bm.ticker in default_benchmarks %}checked{% endif %}
            />
            <label class="form-check-label {% if bm.ticker in default_benchmarks %}fw-bold{% endif %}" for="bmOption{{ forloop.counter0 }}">
              {{ bm.label }}
            </label>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>


  {% if not private_view %}
  <!-- Order History -->
  <h2 class="h5 mb-3">Order History</h2>
  {% if orders_data %}
    <div class="table-responsive mb-4">
      <table class="table table-striped table-sm w-100">
        <thead class="table-light">
          <tr>
            <th scope="col">When</th>
            <th scope="col">Symbol</th>
            <th scope="col">Side</th>
            <th scope="col">Qty</th>
            <th scope="col">Price (Local)</th>
            <th scope="col">FX Rate</th>
            <th scope="col">Total Value (USD)</th>
          </tr>
        </thead>
        <tbody>
          {% for o in orders_data %}
            <tr>
              <td>{{ o.executed_at|date:"Y-m-d H:i" }}</td>
              <td>{{ o.symbol }}</td>
              <td>{{ o.side }}</td>
              <td>{{ o.quantity }}</td>
              <td>
                {% if o.price_local %}
                  {{ o.price_local|floatformat:2 }} {{ o.currency }}
                {% else %}
                  N/A
                {% endif %}
              </td>
              <td>
                {% if o.fx_rate %}
                  1 {{ o.currency }} = ${{ o.fx_rate|floatformat:4 }}
                {% else %}
                  N/A
                {% endif %}
              </td>
              <td>
                {% if o.total_value_usd %}
                  ${{ o.total_value_usd|floatformat:2 }}
                {% else %}
                  N/A
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p class="text-muted"><em>No orders have been placed yet.</em></p>
  {% endif %}
  {% endif %}



{% endblock %}

{% block extra_scripts %}
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // ===== Prepare full data arrays =====
      const historyData = {{ history_data_json|safe }};
      const fullLabels = historyData.map(pt => pt.date);
      const fullPortfolioValues = historyData.map(pt => Number(pt.value));

      const benchmarkData = {{ benchmark_data_json|safe }};
      const fullBenchmarkValues = benchmarkData.map(bm => {
        const map = {};
        bm.data.forEach(pt => (map[pt.date] = Number(pt.price_usd)));
        return fullLabels.map(date => (map[date] !== undefined ? map[date] : null));
      });

      const colorPool = [
        { border: "rgba(0,123,255,1)", background: "rgba(0,123,255,0.2)" },
        { border: "rgba(40,167,69,1)", background: "rgba(40,167,69,0.2)" },
        { border: "rgba(220,53,69,1)", background: "rgba(220,53,69,0.2)" }
      ];
      let availableColors = [...colorPool];

      const datasets = [{
        label: "Portfolio",
        data: [...fullPortfolioValues],
        borderColor: "#000",
        backgroundColor: "rgba(0,0,0,0.1)",
        borderWidth: 3,
        fill: false
      }];

      benchmarkData.forEach((bm, idx) => {
        datasets.push({
          label: bm.label,
          data: [...fullBenchmarkValues[idx]],
          borderColor: "",
          backgroundColor: "",
          borderWidth: 2,
          fill: false,
          hidden: true
        });
      });

      // ===== Instantiate Chart.js =====
      const ctx = document.getElementById("historyChart").getContext("2d");
      const historyChart = new Chart(ctx, {
        type: "line",
        data: { labels: [...fullLabels], datasets: datasets },
        options: {
          scales: {
            x: { display: true, title: { display: true, text: "Date" } },
            y: { display: true, title: { display: true, text: "Value (USD)" }, ticks: { precision: 0 } }
          },
          interaction: {
            mode: 'index',
            intersect: false,
          },
          plugins: {
            legend: {
              labels: {
                filter: (item, data) => {
                  const ds = data?.datasets?.[item.datasetIndex];
                  return ds ? !ds.hidden : true;
                }
              }
            }
          }
        }
      });

      function activeCount() {
        return historyChart.data.datasets.slice(1).filter(ds => !ds.hidden).length;
      }

      function computeReturn(arr) {
        const first = arr.find(v => v !== null && v !== undefined);
        const last = [...arr].reverse().find(v => v !== null && v !== undefined);
        if (first === undefined || last === undefined || first === 0) return null;
        return ((last - first) / first) * 100;
      }

      function updateReturnSummary() {
        const summaryEl = document.getElementById("returnSummary");
        const parts = [];
        const pReturn = computeReturn(historyChart.data.datasets[0].data);
        if (pReturn !== null) parts.push(`Portfolio: ${pReturn.toFixed(2)}%`);
        historyChart.data.datasets.slice(1).forEach(ds => {
          if (!ds.hidden) {
            const r = computeReturn(ds.data);
            if (r !== null) parts.push(`${ds.label}: ${r.toFixed(2)}%`);
          }
        });
        summaryEl.textContent = parts.join(" | ");
      }

      function applyRange(range) {
        const earliest = new Date(fullLabels[0]);
        const latest = new Date(fullLabels[fullLabels.length - 1]);
        let start;
        switch (range) {
          case "1m":
            start = new Date(latest);
            start.setMonth(start.getMonth() - 1);
            break;
          case "6m":
            start = new Date(latest);
            start.setMonth(start.getMonth() - 6);
            break;
          case "1y":
            start = new Date(latest);
            start.setFullYear(start.getFullYear() - 1);
            break;
          case "5y":
            start = new Date(latest);
            start.setFullYear(start.getFullYear() - 5);
            break;
          case "ytd":
            start = new Date(latest.getFullYear(), 0, 1);
            break;
          default:
            start = new Date(earliest);
        }
        if (start < earliest) start = earliest;
        const startIndex = fullLabels.findIndex(d => new Date(d) >= start);
        const sliceStart = startIndex === -1 ? 0 : startIndex;
        historyChart.data.labels = fullLabels.slice(sliceStart);
        historyChart.data.datasets.forEach((ds, idx) => {
          if (idx === 0) {
            ds.data = fullPortfolioValues.slice(sliceStart);
          } else {
            ds.data = fullBenchmarkValues[idx - 1].slice(sliceStart);
          }
        });
        historyChart.update();
        updateReturnSummary();
      }

      function handleBenchmarkToggle(checkbox) {
        const idx = parseInt(checkbox.dataset.index, 10) + 1;
        const ds = historyChart.data.datasets[idx];
        if (checkbox.checked) {
          if (activeCount() >= 3) {
            checkbox.checked = false;
            alert("You can select up to 3 benchmarks.");
            return;
          }
          const color = availableColors.shift();
          if (!color) {
            checkbox.checked = false;
            return;
          }
          ds.borderColor = color.border;
          ds.backgroundColor = color.background;
          ds.borderWidth = 2;
          ds.hidden = false;
          ds._assignedColor = color;
        } else {
          ds.hidden = true;
          if (ds._assignedColor) {
            availableColors.unshift(ds._assignedColor);
            ds._assignedColor = null;
          }
        }
        historyChart.update();
        updateReturnSummary();
      }

      // Initialize benchmark checkboxes
      document.querySelectorAll(".benchmark-option").forEach(checkbox => {
        if (checkbox.checked) {
          handleBenchmarkToggle(checkbox);
        }
        checkbox.addEventListener("change", () => handleBenchmarkToggle(checkbox));
      });

      // Initialize range buttons
      const rangeButtons = document.querySelectorAll("#rangeButtons button");
      rangeButtons.forEach(btn => {
        btn.addEventListener("click", () => {
          rangeButtons.forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          applyRange(btn.dataset.range);
        });
      });

      // Initial summary
      updateReturnSummary();
    });
  </script>
{% endblock %}


