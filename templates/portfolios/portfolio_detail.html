{% extends "portfolios/base.html" %}

{% block title %}{{ portfolio.name }}{% endblock %}

{% block content %}
<div class="space-y-6">
  <div class="flex flex-col gap-3 lg:flex-row lg:items-start lg:justify-between">
    <div class="space-y-2">
      <h1 class="text-3xl font-semibold">{{ portfolio.name }}</h1>
      {% if portfolio.short_description %}
        <p class="muted text-base italic">"{{ portfolio.short_description }}"</p>
      {% endif %}
    </div>
    {% if is_owner %}
      <div class="flex flex-wrap items-center gap-2 justify-start lg:justify-end">
        <form method="post" action="{% url 'portfolios:portfolio-toggle-privacy' %}">
          {% csrf_token %}
          <button type="submit" class="btn-secondary min-w-[9rem]">
            {% if portfolio.is_private %}
              Make Public
            {% else %}
              Make Private
            {% endif %}
          </button>
        </form>
        {% if portfolio.is_private %}
          <a class="btn-secondary min-w-[9rem]" href="{% url 'portfolios:portfolio-allow-list' %}">Allow List ({{ allowed_count }})</a>
        {% endif %}
      </div>
    {% endif %}
  </div>

  {% if not is_owner %}
    {% if not portfolio.is_private or is_allowed %}
      {% if user.is_authenticated %}
        <form method="post" action="{% url 'portfolios:portfolio-follow-toggle' portfolio.pk %}">
          {% csrf_token %}
          <button type="submit" class="btn-primary">
            {% if is_following %}Unfollow Portfolio{% else %}Follow Portfolio{% endif %}
          </button>
        </form>
      {% else %}
        <p>
          <a class="btn-primary" href="{% url 'login' %}?next={{ request.path }}">Follow Portfolio</a>
        </p>
      {% endif %}
    {% endif %}
  {% endif %}

  {% if private_view %}
    <p class="muted italic">This portfolio is private. Only the value chart is visible.</p>
  {% endif %}

  {% if not private_view %}
  <div class="card">
    <div class="card-header">
      <div class="space-y-1">
        <h2 class="section-title">Buy or Sell Shares</h2>
        <p class="muted">Cash Balance: ${{ portfolio.cash_balance|floatformat:2 }}</p>
      </div>
    </div>
    <div class="card-content">
      {% if is_owner %}
      <form method="post" action="{% url 'portfolios:order-create' %}" class="space-y-4" id="orderForm">
        {% csrf_token %}
        <input type="hidden" name="symbol" id="id_symbol" required>

        <div class="grid gap-4 lg:grid-cols-2">
          <div class="space-y-3">
            <div id="tickerSearch" class="flex gap-2">
              <input class="input flex-1" id="tickerLookupInput" placeholder="Enter ticker..." aria-label="Enter ticker">
              <button class="btn-primary" type="button" id="tickerLookupButton">Find</button>
            </div>

            <div id="tickerInfo" class="hidden rounded-xl border border-border bg-slate-50 px-4 py-3">
              <div class="flex items-start justify-between gap-3">
                <div class="space-y-1">
                  <div class="muted uppercase text-xs">Company</div>
                  <div class="text-sm font-semibold" id="tickerCompany"></div>
                  <div class="muted" id="tickerSymbol"></div>
                </div>
                <div class="text-right space-y-1">
                  <div class="muted uppercase text-xs">Current Price</div>
                  <div class="text-sm font-semibold" id="tickerPrice"></div>
                  <span class="badge" id="marketBadge"></span>
                </div>
              </div>
              <button type="button" class="btn-ghost px-0" id="changeTickerButton">Change ticker</button>
            </div>

            <div id="tickerError" class="text-danger text-sm"></div>
          </div>

          <div class="hidden space-y-3" id="orderDetails">
            <div class="grid gap-3 sm:grid-cols-2 sm:items-start">
              <div class="space-y-2">
                <input class="input" name="quantity" id="id_quantity" type="number" step="1" min="1" placeholder="Quantity" required disabled>
                <div class="muted" id="orderAmount"></div>
              </div>
              <div class="flex gap-2">
                <button type="submit" name="side" value="BUY" class="btn-primary order-action-btn w-full" disabled>Buy</button>
                <button type="submit" name="side" value="SELL" class="btn-danger order-action-btn w-full" disabled>Sell</button>
              </div>
            </div>
          </div>
        </div>
      </form>
      {% endif %}

      {% if is_owner and order_form.non_field_errors %}
        <div class="mt-2 text-sm text-danger">{{ order_form.non_field_errors }}</div>
      {% endif %}
    </div>
  </div>

  <div class="card">
    <div class="card-header items-center">
      <div>
        <h2 class="section-title">Current Holdings</h2>
        <p class="muted">Allocation and current prices</p>
      </div>
    </div>
    <div class="card-content">
      {% if positions %}
        <div class="overflow-x-auto">
          <table class="table">
            <thead>
              <tr>
                <th class="table-th">Symbol</th>
                <th class="table-th">Quantity</th>
                <th class="table-th">Current Price</th>
                <th class="table-th">FX Rate</th>
                <th class="table-th text-right">Value (USD)</th>
                <th class="table-th text-right">Allocation</th>
              </tr>
            </thead>
            <tbody>
              {% for pos in positions %}
                <tr>
                  <td class="table-td">{{ pos.symbol }}</td>
                  <td class="table-td">{{ pos.quantity }}</td>
                  <td class="table-td">
                    {% if pos.mid_local is not None %}
                      {{ pos.mid_local|floatformat:2 }} {{ pos.currency }}
                    {% else %}
                      N/A
                    {% endif %}
                  </td>
                  <td class="table-td">
                    {% if pos.fx_rate is not None %}
                      1 {{ pos.currency }} = ${{ pos.fx_rate|floatformat:4 }}
                    {% else %}
                      N/A
                    {% endif %}
                  </td>
                  <td class="table-td text-right">
                    {% if pos.value_usd is not None %}
                      ${{ pos.value_usd|floatformat:2 }}
                    {% else %}
                      N/A
                    {% endif %}
                  </td>
                  <td class="table-td text-right">
                    {% if pos.allocation is not None %}
                      {{ pos.allocation|floatformat:2 }}%
                    {% else %}
                      N/A
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
              <tr>
                <td class="table-td">Cash</td>
                <td class="table-td"></td>
                <td class="table-td"></td>
                <td class="table-td"></td>
                <td class="table-td text-right">${{ portfolio.cash_balance|floatformat:2 }}</td>
                <td class="table-td text-right">{{ cash_allocation|floatformat:2 }}%</td>
              </tr>
              <tr class="bg-slate-50">
                <td class="table-td font-semibold" colspan="4">Total Value</td>
                <td class="table-td font-semibold text-right">${{ total_value|floatformat:2 }}</td>
                <td class="table-td font-semibold text-right">100%</td>
              </tr>
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="muted"><em>No holdings in this portfolio yet.</em></p>
      {% endif %}
    </div>
  </div>
  {% endif %}

  <div class="card">
    <div class="card-header flex-col gap-4 sm:flex-row sm:items-center">
      <div class="space-y-1">
        <h2 class="section-title">Value Over Time</h2>
        <p class="muted">Track performance and compare benchmarks</p>
      </div>
      <div class="flex flex-wrap items-center gap-2 sm:ml-auto">
        <div class="flex flex-wrap gap-2" id="rangeButtons">
          <button type="button" class="pill pill-active" data-range="max">Max</button>
          <button type="button" class="pill" data-range="5y">5Y</button>
          <button type="button" class="pill" data-range="1y">1Y</button>
          <button type="button" class="pill" data-range="ytd">YTD</button>
          <button type="button" class="pill" data-range="6m">6M</button>
          <button type="button" class="pill" data-range="1m">1M</button>
        </div>
        <div id="returnSummary" class="text-right text-sm sm:text-base"></div>
      </div>
    </div>
    <div class="card-content">
      <div class="h-64 sm:h-80">
        <canvas id="historyChart" class="h-full w-full"></canvas>
      </div>
    </div>
  </div>

  <div class="grid gap-6 lg:grid-cols-2">
    <div class="card">
      <div class="card-header">
        <div>
          <h2 class="section-title">Benchmarks</h2>
          <p class="muted">Toggle comparisons</p>
        </div>
      </div>
      <div class="card-content space-y-3">
        {% for bm in benchmark_data %}
          <label class="flex items-center justify-between rounded-xl border border-border px-4 py-3">
            <div>
              <div class="font-semibold text-text">{{ bm.label }}</div>
              <div class="muted">{{ bm.ticker }}</div>
            </div>
            <input
              class="checkbox benchmark-option"
              type="checkbox"
              data-index="{{ forloop.counter0 }}"
              {% if bm.ticker in default_benchmarks %}checked{% endif %}
            />
          </label>
        {% endfor %}
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <div>
          <h2 class="section-title">Recent Orders</h2>
          <p class="muted">Executed trades</p>
        </div>
      </div>
      <div class="card-content">
        {% if orders_data %}
          <div class="overflow-x-auto">
            <table class="table">
              <thead>
                <tr>
                  <th class="table-th">When</th>
                  <th class="table-th">Symbol</th>
                  <th class="table-th">Side</th>
                  <th class="table-th">Qty</th>
                  <th class="table-th">Price (Local)</th>
                  <th class="table-th">FX Rate</th>
                  <th class="table-th text-right">Total Value (USD)</th>
                </tr>
              </thead>
              <tbody>
                {% for o in orders_data %}
                  <tr>
                    <td class="table-td">{{ o.executed_at|date:"Y-m-d H:i" }}</td>
                    <td class="table-td">{{ o.symbol }}</td>
                    <td class="table-td">{{ o.side }}</td>
                    <td class="table-td">{{ o.quantity }}</td>
                    <td class="table-td">
                      {% if o.price_local %}
                        {{ o.price_local|floatformat:2 }} {{ o.currency }}
                      {% else %}
                        N/A
                      {% endif %}
                    </td>
                    <td class="table-td">
                      {% if o.fx_rate %}
                        1 {{ o.currency }} = ${{ o.fx_rate|floatformat:4 }}
                      {% else %}
                        N/A
                      {% endif %}
                    </td>
                    <td class="table-td text-right">
                      {% if o.total_value_usd %}
                        ${{ o.total_value_usd|floatformat:2 }}
                      {% else %}
                        N/A
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="muted"><em>No orders have been placed yet.</em></p>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // ===== Prepare full data arrays =====
      const historyData = {{ history_data_json|safe }};
      const fullLabels = historyData.map(pt => pt.date);
      const fullPortfolioValues = historyData.map(pt => Number(pt.value));

      const benchmarkData = {{ benchmark_data_json|safe }};
      const fullBenchmarkValues = benchmarkData.map(bm => {
        const map = {};
        bm.data.forEach(pt => (map[pt.date] = Number(pt.price_usd)));
        return fullLabels.map(date => (map[date] !== undefined ? map[date] : null));
      });

      const colorPool = [
        { border: "#2563EB", background: "rgba(37,99,235,0.16)" },
        { border: "#16A34A", background: "rgba(22,163,74,0.16)" },
        { border: "#DC2626", background: "rgba(220,38,38,0.12)" }
      ];
      let availableColors = [...colorPool];

      Chart.defaults.font.family = 'Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial';
      Chart.defaults.color = '#0F172A';
      Chart.defaults.borderColor = '#E2E8F0';
      Chart.defaults.plugins.legend.labels.color = '#64748B';

      const datasets = [{
        label: "Portfolio",
        data: [...fullPortfolioValues],
        borderColor: "#2563EB",
        backgroundColor: "rgba(37,99,235,0.12)",
        borderWidth: 3,
        fill: false,
        tension: 0.1,
      }];

      benchmarkData.forEach((bm, idx) => {
        datasets.push({
          label: bm.label,
          data: [...fullBenchmarkValues[idx]],
          borderColor: "",
          backgroundColor: "",
          borderWidth: 2,
          fill: false,
          hidden: true,
          tension: 0.1,
        });
      });

      // ===== Instantiate Chart.js =====
      const ctx = document.getElementById("historyChart").getContext("2d");
      const historyChart = new Chart(ctx, {
        type: "line",
        data: { labels: [...fullLabels], datasets: datasets },
        options: {
          scales: {
            x: { display: true, title: { display: true, text: "Date" }, grid: { color: '#E2E8F0' } },
            y: { display: true, title: { display: true, text: "Value (USD)" }, ticks: { precision: 0 }, grid: { color: '#E2E8F0' } }
          },
          interaction: {
            mode: 'index',
            intersect: false,
          },
          plugins: {
            legend: {
              labels: {
                filter: (item, data) => {
                  const ds = data?.datasets?.[item.datasetIndex];
                  return ds ? !ds.hidden : true;
                }
              }
            }
          }
        }
      });

      function activeCount() {
        return benchmarkData.filter((_, idx) => !datasets[idx + 1].hidden).length;
      }

      function getRangeIndices(range) {
        const endIndex = fullLabels.length - 1;
        switch (range) {
          case '1m': return [Math.max(0, endIndex - 30), endIndex];
          case '6m': return [Math.max(0, endIndex - 180), endIndex];
          case 'ytd': return [fullLabels.findIndex(date => date.startsWith(new Date().getFullYear().toString())), endIndex];
          case '1y': return [Math.max(0, endIndex - 365), endIndex];
          case '5y': return [Math.max(0, endIndex - 365 * 5), endIndex];
          default: return [0, endIndex];
        }
      }

      function updateReturnSummary(startIdx, endIdx) {
        const startValue = fullPortfolioValues[startIdx];
        const endValue = fullPortfolioValues[endIdx];
        const pctChange = startValue && endValue ? ((endValue - startValue) / startValue) * 100 : 0;
        const formatted = pctChange >= 0 ? `+${pctChange.toFixed(2)}%` : `${pctChange.toFixed(2)}%`;
        const colorClass = pctChange >= 0 ? 'text-success' : 'text-danger';

        document.getElementById('returnSummary').innerHTML = `
          <div class="muted">Return</div>
          <div class="font-semibold ${colorClass}">${formatted}</div>
        `;
      }

      function applyRange(range) {
        const [startIdx, endIdx] = getRangeIndices(range);
        historyChart.data.labels = fullLabels.slice(startIdx, endIdx + 1);
        historyChart.data.datasets.forEach((dataset, idx) => {
          const sourceData = idx === 0 ? fullPortfolioValues : fullBenchmarkValues[idx - 1];
          dataset.data = sourceData.slice(startIdx, endIdx + 1);
        });
        historyChart.update();
        updateReturnSummary(startIdx, endIdx);
      }

      // ===== Range selector buttons =====
      const rangeButtons = document.querySelectorAll('#rangeButtons button');
      rangeButtons.forEach(btn => {
        btn.addEventListener("click", () => {
          rangeButtons.forEach(b => b.classList.remove('pill-active'));
          btn.classList.add('pill-active');
          applyRange(btn.dataset.range);
        });
      });
      applyRange('max');

      // ===== Benchmark toggles =====
      const bmOptions = document.querySelectorAll('.benchmark-option');
      bmOptions.forEach((checkbox, idx) => {
        const dataset = historyChart.data.datasets[idx + 1];
        const colors = availableColors.shift() || colorPool[idx % colorPool.length];
        dataset.borderColor = colors.border;
        dataset.backgroundColor = colors.background;
        if (checkbox.checked) {
          dataset.hidden = false;
        }
        checkbox.addEventListener('change', () => {
          dataset.hidden = !checkbox.checked;
          historyChart.update();
        });
      });

      // ===== Buy/Sell order widget =====
      {% if is_owner %}
      const lookupButton = document.getElementById('tickerLookupButton');
      const lookupInput = document.getElementById('tickerLookupInput');
      const tickerSearch = document.getElementById('tickerSearch');
      const tickerInfo = document.getElementById('tickerInfo');
      const tickerCompany = document.getElementById('tickerCompany');
      const tickerSymbol = document.getElementById('tickerSymbol');
      const tickerPrice = document.getElementById('tickerPrice');
      const marketBadge = document.getElementById('marketBadge');
      const changeTickerButton = document.getElementById('changeTickerButton');
      const errorBox = document.getElementById('tickerError');
      const symbolInput = document.getElementById('id_symbol');
      const quantityInput = document.getElementById('id_quantity');
      const actionButtons = document.querySelectorAll('.order-action-btn');
      const orderDetails = document.getElementById('orderDetails');
      const orderForm = document.getElementById('orderForm');
      const orderAmount = document.getElementById('orderAmount');
      const lookupUrl = "{% url 'portfolios:quote-lookup' %}";

      const usdFormatter = new Intl.NumberFormat(undefined, {
        style: 'currency',
        currency: 'USD'
      });

      const setOrderEnabled = (enabled) => {
        quantityInput.disabled = !enabled;
        actionButtons.forEach((btn) => {
          btn.disabled = !enabled;
        });
        orderDetails.classList.toggle('hidden', !enabled);
      };

      const resetLookup = () => {
        symbolInput.value = '';
        tickerCompany.textContent = '';
        tickerSymbol.textContent = '';
        tickerPrice.textContent = '';
        tickerPrice.dataset.price = '';
        tickerPrice.dataset.currency = '';
        tickerPrice.dataset.fxRate = '';
        marketBadge.textContent = '';
        marketBadge.className = 'badge';
        lookupInput.value = '';
        tickerInfo.classList.add('hidden');
        tickerSearch.classList.remove('hidden');
        errorBox.textContent = '';
        orderAmount.textContent = '';
        setOrderEnabled(false);
        lookupInput.focus();
      };

      const formatPrice = (price, currency) => {
        const formatter = new Intl.NumberFormat(undefined, {
          style: 'currency',
          currency: currency || 'USD'
        });
        return formatter.format(price);
      };

      const updateOrderAmount = () => {
        const qty = Number(quantityInput.value);
        if (!Number.isFinite(qty) || qty <= 0) {
          orderAmount.textContent = 'Enter a quantity to see the order value.';
          return;
        }

        const price = Number(tickerPrice.dataset.price);
        const currency = tickerPrice.dataset.currency || 'USD';
        const fxRate = Number(tickerPrice.dataset.fxRate || '1');

        if (!Number.isFinite(price) || !Number.isFinite(fxRate)) {
          orderAmount.textContent = '';
          return;
        }

        const totalLocal = qty * price;
        const totalUsd = totalLocal * fxRate;
        orderAmount.textContent = `Order value: ${usdFormatter.format(totalUsd)}`;
      };

      const showQuote = (data) => {
        tickerCompany.textContent = data.name;
        tickerSymbol.textContent = data.symbol;
        tickerPrice.textContent = formatPrice(data.price, data.currency);
        tickerPrice.dataset.price = data.price;
        tickerPrice.dataset.currency = data.currency || 'USD';
        tickerPrice.dataset.fxRate = data.fx_rate || '1';
        marketBadge.textContent = data.market_open ? 'Market Open' : 'Market Closed';
        marketBadge.className = data.market_open ? 'badge text-success bg-green-50' : 'badge text-muted';
        symbolInput.value = data.symbol;
        tickerSearch.classList.add('hidden');
        tickerInfo.classList.remove('hidden');
        setOrderEnabled(true);
        updateOrderAmount();
        quantityInput.focus();
      };

      const handleLookup = (event) => {
        event.preventDefault();
        const ticker = lookupInput.value.trim();
        errorBox.textContent = '';

        if (!ticker) {
          errorBox.textContent = 'Please enter a ticker symbol.';
          return;
        }

        lookupButton.disabled = true;
        lookupButton.textContent = 'Finding...';

        fetch(`${lookupUrl}?symbol=${encodeURIComponent(ticker)}`)
          .then((response) => response.json().then((data) => ({ ok: response.ok, data })))
          .then(({ ok, data }) => {
            if (!ok) {
              throw new Error(data.error || 'Unable to find that ticker.');
            }
            showQuote(data);
          })
          .catch((error) => {
            errorBox.textContent = error.message;
          })
          .finally(() => {
            lookupButton.disabled = false;
            lookupButton.textContent = 'Find';
          });
      };

      lookupButton.addEventListener('click', handleLookup);

      lookupInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
          handleLookup(event);
        }
      });

      changeTickerButton.addEventListener('click', resetLookup);

      quantityInput.addEventListener('input', updateOrderAmount);

      orderForm.addEventListener('submit', (event) => {
        if (!symbolInput.value) {
          event.preventDefault();
          errorBox.textContent = 'Please look up a ticker before placing an order.';
          resetLookup();
        }
      });
      {% endif %}
    });
  </script>
{% endblock %}
