{% extends "portfolios/base.html" %}

{% block title %}{{ portfolio.name }}{% endblock %}

{% block content %}
  <h1 class="mb-4">{{ portfolio.name }}</h1>

  {% if is_owner %}
    <form method="post" action="{% url 'portfolios:portfolio-toggle-privacy' %}" class="mb-3">
      {% csrf_token %}
      <button type="submit" class="btn btn-secondary">
        {% if portfolio.is_private %}
          Make Portfolio Public
        {% else %}
          Make Portfolio Private
        {% endif %}
      </button>
    </form>
  {% endif %}

  {% if private_view %}
    <p class="text-muted"><em>This portfolio is private. Only the value chart is visible.</em></p>
  {% endif %}

  {% if not private_view %}
  <div class="card mb-4">
    <div class="card-body">
      <p>
        <strong>Cash Balance (USD):</strong>
        ${{ portfolio.cash_balance|floatformat:2 }}
      </p>
      {% if is_owner %}
      <p class="mt-3">
        <a class="btn btn-primary" href="{% url 'portfolios:order-create' %}">
          Place Buy/Sell Order
        </a>
      </p>
      {% endif %}
    </div>
  </div>

  <!-- Current Holdings -->
  <h2 class="h5 mb-3">Current Holdings</h2>
  {% if positions %}
    <div class="table-responsive mb-4">
      <table class="table table-striped w-100">
        <thead class="table-light">
          <tr>
            <th scope="col">Symbol</th>
            <th scope="col">Quantity</th>
            <th scope="col">Price (local)</th>
            <th scope="col">FX Rate (â†’USD)</th>
            <th scope="col">Value (USD)</th>
          </tr>
        </thead>
        <tbody>
          {% for pos in positions %}
            <tr>
              <td>{{ pos.symbol }}</td>
              <td>{{ pos.quantity }}</td>
              <td>
                {% if pos.mid_local is not None %}
                  {{ pos.mid_local|floatformat:2 }} {{ pos.currency }}
                {% else %}
                  N/A
                {% endif %}
              </td>
              <td>
                {% if pos.fx_rate is not None %}
                  1 {{ pos.currency }} = ${{ pos.fx_rate|floatformat:4 }}
                {% else %}
                  N/A
                {% endif %}
              </td>
              <td>
                {% if pos.value_usd is not None %}
                  ${{ pos.value_usd|floatformat:2 }}
                {% else %}
                  N/A
                {% endif %}
              </td>
            </tr>
          {% endfor %}
          <tr>
            <td>Cash</td>
            <td></td>
            <td></td>
            <td></td>
            <td>${{ portfolio.cash_balance|floatformat:2 }}</td>
          </tr>
          <tr class="table-light">
            <td colspan="4"><strong>Total Value</strong></td>
            <td><strong>${{ total_value|floatformat:2 }}</strong></td>
          </tr>
        </tbody>
      </table>
    </div>
  {% else %}
    <p class="text-muted"><em>No holdings in this portfolio yet.</em></p>
  {% endif %}
  {% endif %}

  <!-- Value Over Time -->
  <h2 class="h5 mb-3">Value Over Time</h2>
  <div class="mb-4">
    <canvas id="historyChart" style="max-width:100%; height:auto;"></canvas>
  </div>

  <div class="mb-4">
    <label class="form-label">Toggle benchmarks:</label>
    <div>
      {% for bm in benchmark_data %}
        <div class="form-check form-check-inline">
          <input
            class="form-check-input benchmark-toggle"
            type="checkbox"
            id="bmToggle{{ forloop.counter0 }}"
            data-index="{{ forloop.counter0 }}"
            {% if bm.ticker in default_benchmarks %}checked{% endif %}
          />
          <label class="form-check-label" for="bmToggle{{ forloop.counter0 }}">
            {{ bm.label }}
          </label>
        </div>
      {% endfor %}
    </div>
  </div>


  {% if not private_view %}
  <!-- Order History -->
  <h2 class="h5 mb-3">Order History</h2>
  {% if orders_data %}
    <div class="table-responsive mb-4">
      <table class="table table-striped table-sm w-100">
        <thead class="table-light">
          <tr>
            <th scope="col">When</th>
            <th scope="col">Symbol</th>
            <th scope="col">Side</th>
            <th scope="col">Qty</th>
            <th scope="col">Price (Local)</th>
            <th scope="col">FX Rate</th>
            <th scope="col">Total Value (USD)</th>
          </tr>
        </thead>
        <tbody>
          {% for o in orders_data %}
            <tr>
              <td>{{ o.executed_at|date:"Y-m-d H:i" }}</td>
              <td>{{ o.symbol }}</td>
              <td>{{ o.side }}</td>
              <td>{{ o.quantity }}</td>
              <td>
                {% if o.price_local %}
                  {{ o.price_local|floatformat:2 }} {{ o.currency }}
                {% else %}
                  N/A
                {% endif %}
              </td>
              <td>
                {% if o.fx_rate %}
                  1 {{ o.currency }} = ${{ o.fx_rate|floatformat:4 }}
                {% else %}
                  N/A
                {% endif %}
              </td>
              <td>
                {% if o.total_value_usd %}
                  ${{ o.total_value_usd|floatformat:2 }}
                {% else %}
                  N/A
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p class="text-muted"><em>No orders have been placed yet.</em></p>
  {% endif %}
  {% endif %}



{% endblock %}

{% block extra_scripts %}
  <!-- Chart.js (same as before) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // 1) Prepare the portfolio dataset
      const historyData = {{ history_data_json|safe }};
      const labels = historyData.map(pt => pt.date);
      const portfolioValues = historyData.map(pt => pt.value);

      const datasets = [{
        label: "Portfolio",
        data: portfolioValues,
        borderColor: "rgba(40, 167, 69, 1)",   // green
        backgroundColor: "rgba(40, 167, 69, 0.2)",
        borderWidth: 2,
        fill: false
      }];

        // 2) Add one dataset per benchmark
        const benchmarkData = {{ benchmark_data_json|safe }};
        const defaultBenchmarks = {{ default_benchmarks|safe }};
        benchmarkData.forEach((bm, idx) => {
          const priceMap = {};
          bm.data.forEach(pt => priceMap[pt.date] = pt.price_usd);
          const bmPrices = labels.map(date => priceMap[date] ?? null);

          datasets.push({
            label: bm.label,
            data: bmPrices,
            borderColor: `rgba(${50 + idx*60}, ${100 + idx*30}, ${200 - idx*40}, 1)`,
            backgroundColor: `rgba(${50 + idx*60}, ${100 + idx*30}, ${200 - idx*40}, 0.2)`,
            borderWidth: 1.5,
            fill: false,
            hidden: !defaultBenchmarks.includes(bm.ticker)
          });
        });

      // 3) Instantiate Chart.js
      const ctx = document.getElementById("historyChart").getContext("2d");
      const historyChart = new Chart(ctx, {
        type: "line",
        data: { labels: labels, datasets: datasets },
        options: {
          scales: {
            x: { display: true, title: { display: true, text: "Date" } },
            y: { display: true, title: { display: true, text: "Value (USD)" }, ticks: {precision: 0} }
          },
          interaction: {
            mode: 'index',
            intersect: false,
          },
        }
      });

      // 4) Toggle benchmark datasets
      document.querySelectorAll(".benchmark-toggle").forEach(checkbox => {
        checkbox.addEventListener("change", (e) => {
          const idx = parseInt(e.target.dataset.index, 10) + 1;
          historyChart.data.datasets[idx].hidden = !e.target.checked;
          historyChart.update();
        });
      });
    });
  </script>
{% endblock %}


